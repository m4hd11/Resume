{% load static %}
{% load blog_tags %}
{% load excerpt_tags %}
<section id="latest-posts" class="latest-posts section light-background py-5">
  <div class="container" data-aos="fade-up">
    <!-- Section Title -->
    <div class="row mb-4 text-center">
      <div class="col">
        <h2>Latest Posts</h2>
        <p>Check out my recent blog posts and tutorials</p>
      </div>
    </div>
    
    <!-- Carousel -->
    <div id="latestPostsCarousel" class="carousel slide" data-bs-ride="false" data-bs-interval="false">
      <!-- Carousel Inner -->
      <div class="carousel-inner">
        {% for post in posts %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="row justify-content-center">
              <div class="col-12 col-md-10 col-lg-4">
                <div class="card latest-post-card h-100 shadow-sm">
                  {% if post.image %}
                    <a href="{% url 'blog:single' pid=post.id %}">
                      <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}">
                    </a>
                  {% else %}
                    <img src="{% static 'assets/img/default.avif' %}" class="card-img-top" alt="{{ post.title }}">
                  {% endif %}
                  <div class="card-body d-flex flex-column">
                    <div class="post-categories mb-2">
                      {% for cat in post.category.all %}
                        <a href="{% url 'blog:category' cat_name=cat.name %}" class="badge bg-primary me-1 category-link">{{ cat.name }}</a>
                      {% endfor %}
                    </div>
                    <h5 class="card-title">
                      <a href="{% url 'blog:single' post.id %}" class="post-title-link">{{ post.title }}</a>
                    </h5>
                    <p class="card-text">{{ post.content|excerpt:30|safe }}...</p>
                    <a href="{% url 'blog:single' post.id %}" class="btn btn-primary mt-auto">Read More</a>
                  </div>
                  <div class="card-footer text-muted">
                    {{ post.published_date|date:"d M Y" }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <!-- Custom Indicators -->
      <div class="text-center mt-4">
        <div class="d-inline-block" id="customIndicators">
          {% for post in posts %}
            <button type="button" class="custom-indicator {% if forloop.first %}active{% endif %}" 
                    data-bs-target="#latestPostsCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                    aria-label="Slide {{ forloop.counter }}"></button>
          {% endfor %}
        </div>
      </div>
      
      <!-- Controls -->
      <button class="carousel-control-prev" type="button" data-bs-target="#latestPostsCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#latestPostsCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>
  </div>
</section>

<style>
/* Latest Posts Carousel Styles */
.latest-posts {
  position: relative;
  isolation: isolate;
  z-index: 1;
}

.latest-posts * {
  font-family: 'Roboto', sans-serif !important;
}

#latestPostsCarousel {
  position: relative;
  z-index: 1;
}

.carousel-inner {
  overflow: visible;
}

.latest-post-card {
  border-radius: 10px;
  overflow: hidden;
  transition: transform 0.3s, box-shadow 0.3s;
  border: 1px solid rgba(0,0,0,.125);
  background-color: #fff;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.latest-post-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0,0,0,0.2);
}

.latest-post-card .card-img-top {
  height: 200px;
  object-fit: cover;
  width: 100%;
  flex-shrink: 0;
}

.latest-post-card .card-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 1.25rem;
}

.post-title-link {
  color: #0d6efd !important;
  text-decoration: none;
  transition: color 0.3s;
  font-weight: 600 !important;
  font-size: 1.1rem !important;
  font-family: 'Roboto', sans-serif !important;
}

.post-title-link:hover {
  color: #0056b3 !important;
  text-decoration: underline;
}

.card-text {
  color: #6c757d !important;
  font-size: 0.95rem !important;
  line-height: 1.6 !important;
  font-family: 'Roboto', sans-serif !important;
}

.card-title {
  margin-bottom: 0.75rem !important;
  font-family: 'Roboto', sans-serif !important;
}

.card-footer {
  font-family: 'Roboto', sans-serif !important;
  font-size: 0.875rem !important;
  padding: 0.75rem 1.25rem !important;
}

.category-link {
  text-decoration: none;
  transition: background-color 0.3s, color 0.3s;
  font-size: 0.75rem !important;
  padding: 0.35em 0.65em;
  font-family: 'Roboto', sans-serif !important;
}

.category-link:hover {
  background-color: #0056b3 !important;
  color: #fff !important;
}

.post-categories {
  margin-bottom: 0.5rem;
}

/* Custom Indicators */
#customIndicators {
  position: relative;
  z-index: 2;
}

.custom-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: #ddd;
  border: 2px solid transparent;
  margin: 0 5px;
  padding: 0;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-block;
}

.custom-indicator:hover {
  background-color: #0a58ca;
  transform: scale(1.2);
}

.custom-indicator.active {
  background-color: #0d6efd;
  width: 30px;
  border-radius: 6px;
}

/* Carousel Controls */
.carousel-control-prev,
.carousel-control-next {
  width: 8%;
  opacity: 0.7;
  z-index: 2;
}

.carousel-control-prev:hover,
.carousel-control-next:hover {
  opacity: 1;
}

.carousel-control-prev-icon,
.carousel-control-next-icon {
  background-color: rgba(0,0,0,0.5);
  border-radius: 50%;
  padding: 20px;
}

/* Desktop - Group 3 cards per slide */
@media (min-width: 992px) {
  .carousel-inner .carousel-item .row {
    display: flex;
    flex-wrap: wrap;
  }
  
  .carousel-inner .carousel-item {
    transition: transform 0.6s ease-in-out;
  }
  
  .latest-post-card .card-img-top {
    height: 220px;
  }
}

/* Tablet */
@media (min-width: 768px) and (max-width: 991.98px) {
  .latest-post-card .card-img-top {
    height: 200px;
  }
  
  .post-title-link {
    font-size: 1rem !important;
  }
  
  .card-text {
    font-size: 0.9rem !important;
  }
  
  .carousel-control-prev,
  .carousel-control-next {
    width: 10%;
  }
}

/* Mobile - 1 card per slide with consistent sizing */
@media (max-width: 767.98px) {
  .latest-post-card {
    max-width: 100%;
    margin: 0 auto;
  }
  
  .latest-post-card .card-img-top {
    height: 200px !important;
  }
  
  .post-title-link {
    font-size: 1rem !important;
  }
  
  .card-text {
    font-size: 0.9rem !important;
  }
  
  .card-body {
    padding: 1rem !important;
  }
  
  .card-footer {
    font-size: 0.8rem !important;
    padding: 0.65rem 1rem !important;
  }
  
  .carousel-inner {
    touch-action: pan-y pinch-zoom;
  }
  
  .carousel-control-prev,
  .carousel-control-next {
    width: 12%;
  }
  
  .carousel-control-prev-icon,
  .carousel-control-next-icon {
    padding: 15px;
  }
  
  /* اطمینان از اینکه تمام کارت‌ها یک اندازه هستن */
  .carousel-item .row {
    min-height: 450px;
  }
  
  .latest-post-card {
    min-height: 420px;
  }
}

@media (max-width: 575.98px) {
  .latest-post-card .card-img-top {
    height: 180px !important;
  }
  
  .post-title-link {
    font-size: 0.95rem !important;
  }
  
  .card-text {
    font-size: 0.875rem !important;
  }
  
  .carousel-item .row {
    min-height: 420px;
  }
  
  .latest-post-card {
    min-height: 400px;
  }
}
</style>

<script>
(function() {
  // جلوگیری از اجرای مکرر
  if (window.carouselInitialized) return;
  window.carouselInitialized = true;

  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('latestPostsCarousel');
    if (!carousel) return;
    
    const carouselInner = carousel.querySelector('.carousel-inner');
    const items = carousel.querySelectorAll('.carousel-item');
    const indicators = carousel.querySelectorAll('.custom-indicator');
    
    // Desktop: Group 3 cards per slide
    function regroupCarouselItems() {
      const isDesktop = window.innerWidth >= 992;
      
      if (isDesktop && items.length > 0) {
        // Group cards into sets of 3
        const allCards = Array.from(items).map(item => item.querySelector('.col-12').cloneNode(true));
        carouselInner.innerHTML = '';
        
        for (let i = 0; i < allCards.length; i += 3) {
          const slideDiv = document.createElement('div');
          slideDiv.className = 'carousel-item' + (i === 0 ? ' active' : '');
          
          const rowDiv = document.createElement('div');
          rowDiv.className = 'row justify-content-center g-4';
          
          for (let j = i; j < Math.min(i + 3, allCards.length); j++) {
            const col = allCards[j].cloneNode(true);
            col.className = 'col-lg-4 col-md-6 col-12';
            rowDiv.appendChild(col);
          }
          
          slideDiv.appendChild(rowDiv);
          carouselInner.appendChild(slideDiv);
        }
        
        // Update indicators for grouped view
        const newSlideCount = Math.ceil(allCards.length / 3);
        updateIndicators(newSlideCount);
      }
    }
    
    function updateIndicators(count) {
      const indicatorsContainer = document.getElementById('customIndicators');
      if (!indicatorsContainer) return;
      
      indicatorsContainer.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'custom-indicator' + (i === 0 ? ' active' : '');
        btn.setAttribute('data-bs-target', '#latestPostsCarousel');
        btn.setAttribute('data-bs-slide-to', i);
        btn.setAttribute('aria-label', 'Slide ' + (i + 1));
        indicatorsContainer.appendChild(btn);
      }
    }
    
    // Update on load
    regroupCarouselItems();
    
    // Sync custom indicators with carousel
    if (carousel) {
      carousel.addEventListener('slide.bs.carousel', function(e) {
        const allIndicators = document.querySelectorAll('.custom-indicator');
        allIndicators.forEach((indicator, index) => {
          indicator.classList.toggle('active', index === e.to);
        });
      });
    }
  });
})();
</script>